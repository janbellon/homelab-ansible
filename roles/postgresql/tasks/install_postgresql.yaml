---
- name: Postgres | Install | Install PostgreSQL from APT
  ansible.builtin.apt:
    name: postgresql
    state: present
    update_cache: yes

- name: Postgres | Install | Import pgadmin GPG key
  ansible.builtin.get_url:
    url: https://www.pgadmin.org/static/packages_pgadmin_org.pub
    dest: /tmp/packages_pgadmin_org.pub
    mode: '0644'

- name: Postgres | Install | Create pgadmin keyrings folder
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: '0755'

- name: Postgres | Install | Add pgadmin GPG key to keyrings
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/packages_pgadmin_org.pub > /usr/share/keyrings/packages-pgadmin-org.gpg
  args:
    creates: /usr/share/keyrings/packages-pgadmin-org.gpg

- name: Postgres | Isntall | Add pgadmin4 repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/{{ ansible_distribution_release }} pgadmin4 main"
    state: present
    filename: pgadmin4          # creates /etc/apt/sources.list.d/pgadmin4.list
    update_cache: no            # on le fait dans la t√¢che suivante

- name: Postgres | Install | Update APT cache
  ansible.builtin.apt:
    update_cache: yes

- name: Postgres | Install | Install pgadmin4 using APT
  ansible.builtin.apt: 
    name: pgadmin4
    state: present

- name: Postgres | Install | Create pgadmin configuration base
  ansible.builtin.command: /usr/pgadmin4/venv/bin/python3 /usr/pgadmin4/web/setup.py setup-db
  args:
    creates: /var/lib/pgadmin/pgadmin4.db   # idempotent : ne relance pas si la DB existe

- name: Postgres | Install | Create pgadmin directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ 'apache' if ansible_os_family == 'RedHat' else
               'wwwrun' if ansible_os_family == 'Suse' else
               'www-data' }}"
    group: "{{ 'apache' if ansible_os_family == 'RedHat' else
               'wwwrun' if ansible_os_family == 'Suse' else
               'www-data' }}"
    mode: '0755'
  loop:
    - /var/log/pgadmin
    - /var/lib/pgadmin

- name: Postgres | Install | Apply Selinux policy (Redhat only)
  when: ansible_os_family == "RedHat"
  block:
    - ansible.posix.seboolean:
        name: "{{ item }}"
        state: yes
        persistent: yes
      loop:
        - httpd_tmp_exec
        - httpd_can_network_connect
        - httpd_can_network_connect_db

    - ansible.builtin.command: semanage fcontext -a -t httpd_var_lib_t "/var/lib/pgadmin(/.*)?"
      changed_when: false
      failed_when: false
    - ansible.builtin.command: restorecon -R -v /var/lib/pgadmin
      changed_when: false

    - ansible.builtin.command: semanage fcontext -a -t httpd_log_t "/var/log/pgadmin(/.*)?"
      changed_when: false
      failed_when: false
    - ansible.builtin.command: restorecon -R -v /var/log/pgadmin
      changed_when: false

- name: Postgres | Install | Activate WSGI module and pgAdmin config (Debian/Ubuntu)
  when: ansible_os_family == "Debian"
  block:
    - ansible.builtin.command: a2enmod wsgi
      changed_when: true
    - ansible.builtin.command: a2enconf pgadmin4
      changed_when: true

- name: Postgres | Install | Restart Apache if service is active
  ansible.builtin.systemd:
    name: "{{ 'httpd' if ansible_os_family == 'RedHat' else 'apache2' }}"
    state: restarted
    enabled: yes
  when: ansible_facts.services[('httpd' if ansible_os_family == 'RedHat' else 'apache2')] is defined
        and ansible_facts.services[('httpd' if ansible_os_family == 'RedHat' else 'apache2')].state == "running"

- name: Postgres | Install | Start Apache if not active
  ansible.builtin.systemd:
    name: "{{ 'httpd' if ansible_os_family == 'RedHat' else 'apache2' }}"
    state: started
    enabled: yes

