services:
  gitlab:
    image: gitlab/gitlab-ce:{{ gitlab.version }}
    container_name: gitlab
    restart: always
    hostname: '{{ gitlab.domain }}'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # Add any other gitlab.rb configuration here, each on its own line
        external_url 'https://{{ gitlab.domain }}'
        gitlab_rails['object_store']['enabled'] = true
        gitlab_rails['object_store']['connection'] = {
          'provider' => 'AWS',
          'region' => 'us-east-1',
          'endpoint' => '{{ globvar.s3.host }}',
          'aws_access_key_id' => '{{ gitlab.s3.access_key }}',
          'aws_secret_access_key' => '{{ gitlab.s3.secret_key }}',
          'path_style' => true
        }
        gitlab_rails['object_store']['objects']['uploads']['bucket'] = 'gitlab'
        gitlab_rails['object_store']['objects']['lfs']['bucket'] = 'gitlab-lfs'
        gitlab_rails['object_store']['objects']['artifacts']['bucket'] = 'gitlab'
        gitlab_rails['object_store']['objects']['external_diffs']['bucket'] = 'gitlab'
        gitlab_rails['object_store']['objects']['packages']['bucket'] = 'gitlab'
        gitlab_rails['object_store']['objects']['dependency_proxy']['bucket'] = 'gitlab'
        gitlab_rails['object_store']['objects']['terraform_state']['bucket'] = 'gitlab'
        gitlab_rails['object_store']['objects']['pages']['bucket'] = 'gitlab'
        gitlab_rails['object_store']['objects']['ci_secure_files']['bucket'] = 'gitlab'
        gitlab_rails['smtp_enable'] = true
        gitlab_rails['smtp_address'] = '{{ globvar.smtp.host }}'
        gitlab_rails['smtp_port'] = '{{ globvar.smtp.port }}'
        gitlab_rails['smtp_domain'] = '{{ globvar.smtp.domain }}'
        gitlab_rails['gitlab_email_from'] = '{{ globvar.smtp.email }}'
        gitlab_rails['gitlab_email_reply_to'] = '{{ globvar.smtp.email }}'
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'unicode'
        gitlab_rails['db_collation'] = nil
        gitlab_rails['db_database'] = '{{ gitlab.db.name }}'
        gitlab_rails['db_username'] = '{{ gitlab.db.user }}'
        gitlab_rails['db_password'] = '{{ gitlab.db.password }}'
        gitlab_rails['db_host'] = '{{ globvar.db.host }}'
        gitlab_rails['db_port'] = '{{ globvar.db.port }}'
        gitlab_rails['db_sslmode'] = '{{ globvar.db.ssl }}'
    ports:
      - '80:80'
      - '443:443'
      - '2222:22'
    volumes:
      - './gitlab/config:/etc/gitlab'
      - './gitlab/logs:/var/log/gitlab'
      - './gitlab/data:/var/opt/gitlab'
    shm_size: '256m'